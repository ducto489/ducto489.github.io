<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Train GPT-2 with TPU | Dustin Nguyen </title> <meta name="author" content="Dustin Nguyen"> <meta name="description" content="Using TPU to speedup and recreate GPT-2 result"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a26b1b0e2d9c9dd2e5ed17c987a37731"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?9dbe0c76bacd463500b79ed6a86e27ac"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/faviconphoto.jpg?89d3779cde599fb5f5a3b84c36489ca0"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://ducto489.github.io/projects/train-gpt-2-with-tpu/"> <script src="/assets/js/theme.js?bd888c560287cd675855c7662a167c4a"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?3e7054dc4d3e3dd8f0731a48453e618e"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> </head> <body> <d-front-matter> <script async type="text/json">
      {
            "title": "Train GPT-2 with TPU",
            "description": "Using TPU to speedup and recreate GPT-2 result",
            "published": "August 29, 2024",
            "authors": [
              
            ],
            "katex": {
              "delimiters": [
                {
                  "left": "$",
                  "right": "$",
                  "display": false
                },
                {
                  "left": "$$",
                  "right": "$$",
                  "display": true
                }
              ]
            }
          }
    </script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Dustin</span> Nguyen </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">Project <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link"> <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="post distill"> <d-title> <h1>Train GPT-2 with TPU</h1> <p>Using TPU to speedup and recreate GPT-2 result</p> </d-title> <d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div> <a href="#overview">Overview</a> </div> <div> <a href="#key-challenges-and-solutions">Key Challenges and Solutions</a> </div> <ul> <li> <a href="#1-disk-memory-limitation">1. Disk Memory Limitation</a> </li> <li> <a href="#2-slow-training-on-gpu-t4-x2">2. Slow Training on GPU T4 x2</a> </li> </ul> <div> <a href="#techniques-used">Techniques Used</a> </div> <div> <a href="#result">Result</a> </div> <div> <a href="#learn-more">Learn More</a> </div> </nav> </d-contents> <h2 id="overview">Overview</h2> <p>This project was inspired by <a href="https://youtu.be/l8pRSuU81PU?si=6_loh9yI5Fj6ut1g" rel="external nofollow noopener" target="_blank">Andrej Karparthy’s video</a>. Here I stick to the GPT-2 and GPT-3 paper to reproduce the model and techniques. I applied gradient accumulation, distributed data parallel (GPU and TPU), half-precision, flash attention, and nice numbers (the number that can be divided by 2 the most). I trained on FineWeb (EDU), which is the same dataset that GPT -2 has trained on. For evaluation, I used a different dataset and a HellaSwag for comparison to the GPT-2 paper.</p> <p>But if you don’t have powerful GPUs or have money for GPU rental. We still can achieve GPT-2 124M performance with TPU on Kaggle! But we have some problems to solve.</p> <h2 id="key-challenges-and-solutions">Key Challenges and Solutions</h2> <h3 id="1-disk-memory-limitation">1. Disk Memory Limitation</h3> <p>In Kaggle we only have 40GB of disk memory. If we use the saving and loading data technique in Andrej Karpathy’s videos, we end up running out of disk space before the training stuff begins.</p> <p><strong>Solution:</strong> Implemented streaming techniques from the datasets library, allowing for efficient data handling during training and evaluation.</p> <h3 id="2-slow-training-on-gpu-t4-x2">2. Slow Training on GPU T4 x2</h3> <p>GPU T4 doesn’t support BF16. If we use float16 the loss will increase.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/BUGtrainGPU-480.webp 480w,/assets/img/BUGtrainGPU-800.webp 800w,/assets/img/BUGtrainGPU-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/BUGtrainGPU.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>Using float32 causes pain in the neck when it slows down the training process very much. We achieved 7.400 tokens/sec. For comparison, Andrej Karparthy achieved 1.242.000 tokens/sec. After 12 hours of training, we reach the 295/19073 step. Not even close!</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/trainGPU-480.webp 480w,/assets/img/trainGPU-800.webp 800w,/assets/img/trainGPU-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/trainGPU.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p><strong>Solution:</strong> TPU supports BF16 and it is even faster!</p> <h2 id="techniques-used">Techniques Used</h2> <ul> <li> <strong>Gradient Accumulation</strong>: To simulate larger batch sizes without requiring extensive memory.</li> <li> <strong>Half-Precision (BF16)</strong>: Leveraging TPU’s support for BF16 to improve training speed and reduce memory usage.</li> <li> <strong>Distributed Data Parallel</strong>: To accelerate training by distributing the workload across multiple TPU cores.</li> <li> <strong>Flash Attention</strong>: Optimized attention mechanism for faster computation.</li> <li> <strong>“Nice Numbers”</strong>: Applied values divisible by 2 as much as possible to optimize memory usage.</li> <li>And some other TPU optimization.</li> </ul> <h2 id="result">Result</h2> <p>After applying TPU, BF16, and some other TPU optimization and running for 18 hours I finally <strong>surpassed GPT-2 124M model</strong> with validation loss 3.2754 over 3.2924 and HellaSwag evaluation 0.2962 over 0.294463! We achieved 243.000 tokens/sec meaning that we sped up the training by 243.000 / 7.400 = <strong>33 times</strong> compared to GPU T4 x2!</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/trainTPU-480.webp 480w,/assets/img/trainTPU-800.webp 800w,/assets/img/trainTPU-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/trainTPU.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>Here are some fun text examples that generated from my model:</p> <ul> <li>Hello, I’m a language model, and I do have a great understanding of everything about AI (including its applications). Although I don’t think it’s a</li> <li>Hello, I’m a language model, and here’s all I want to put a bit more energy into figuring out what words in English could mean in English.</li> <li>Hello, I’m a language model, and I can help you find language translations where you can even use “words” in dictionaries or translations. I’m</li> <li>Hello, I’m a language model, I’m a linguist for Learning English. I’m trying to teach people language and English through a series of lectures in</li> </ul> <h2 id="learn-more">Learn More</h2> <p>For a detailed exploration of the code, datasets, and methods, you can view this <a href="https://www.kaggle.com/code/dustnn/train-gpt-2-with-tpu" rel="external nofollow noopener" target="_blank">Kaggle Notebook</a>.</p> <hr> <p><em>This project demonstrates the feasibility of training large language models like GPT-2 on Kaggle’s TPU, overcoming hardware limitations and achieving significant performance improvements.</em></p> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/"></d-bibliography> <div id="disqus_thread" style="max-width: 930px; margin: 0 auto;"> <script type="text/javascript">var disqus_shortname="ducto489",disqus_identifier="/projects/train-gpt-2-with-tpu",disqus_title="Train GPT-2 with TPU";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}();</script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by Disqus.</a> </noscript> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Dustin Nguyen. </div> </footer> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script src="/assets/js/vanilla-back-to-top.min.js?982c80efc910ea9a6203400dcbd0a3af"></script> <script>addBackToTop();</script> <script type="module" src="/assets/js/search/ninja-keys.min.js?101922ace415c3a07fdb5a0877aad48f"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script>let searchTheme=determineComputedTheme();const ninjaKeys=document.querySelector("ninja-keys");"dark"===searchTheme?ninjaKeys.classList.add("dark"):ninjaKeys.classList.remove("dark");const openSearchModal=()=>{const e=$("#navbarNav");e.hasClass("show")&&e.collapse("hide"),ninjaKeys.open()};</script> <script>const ninja=document.querySelector("ninja-keys");ninja.data=[{id:"nav-about",title:"About",section:"Navigation",handler:()=>{window.location.href="/"}},{id:"nav-project",title:"Project",description:"",section:"Navigation",handler:()=>{window.location.href="/projects/"}},{id:"nav-cv",title:"CV",description:"For full details, please see my CV (PDF) located on the right .",section:"Navigation",handler:()=>{window.location.href="/cv/"}},{id:"news-a-simple-inline-announcement",title:"A simple inline announcement.",description:"",section:"News"},{id:"news-a-long-announcement-with-details",title:"A long announcement with details",description:"",section:"News",handler:()=>{window.location.href="/news/announcement_2/"}},{id:"news-a-simple-inline-announcement-with-markdown-emoji-sparkles-smile",title:'A simple inline announcement with Markdown emoji! <img class="emoji" title=":sparkles:" alt=":sparkles:" src="https://github.githubassets.com/images/icons/emoji/unicode/2728.png" height="20" width="20"> <img class="emoji" title=":smile:" alt=":smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f604.png" height="20" width="20">',description:"",section:"News"},{id:"projects-quantum-random-walk",title:"Quantum Random Walk",description:"The behavior of quantum random walks (QRWs) using the Creutz ladder model",section:"Projects",handler:()=>{window.location.href="/projects/qrw/"}},{id:"projects-train-gpt-2-with-tpu",title:"Train GPT-2 with TPU",description:"Using TPU to speedup and recreate GPT-2 result",section:"Projects",handler:()=>{window.location.href="/projects/train-gpt-2-with-tpu/"}},{id:"projects-rl-play-worlde",title:"RL play Worlde",description:"Using RL to train a bot play wordle",section:"Projects",handler:()=>{window.location.href="/projects/wordle/"}},{id:"socials-email",title:"Send email",section:"Socials",handler:()=>{window.open("mailto:%64%75%73%74%6E%6E%30%30@%67%6D%61%69%6C.%63%6F%6D","_blank")}},{id:"socials-github",title:"GitHub",section:"Socials",handler:()=>{window.open("https://github.com/ducto489","_blank")}},{id:"socials-linkedin",title:"LinkedIn",section:"Socials",handler:()=>{window.open("https://www.linkedin.com/in/dustnn","_blank")}},{id:"socials-facebook",title:"Facebook",section:"Socials",handler:()=>{window.open("https://facebook.com/minhduc.876","_blank")}},{id:"light-theme",title:"Change theme to light",description:"Change the theme of the site to Light",section:"Theme",handler:()=>{setThemeSetting("light")}},{id:"dark-theme",title:"Change theme to dark",description:"Change the theme of the site to Dark",section:"Theme",handler:()=>{setThemeSetting("dark")}},{id:"system-theme",title:"Use system default theme",description:"Change the theme of the site to System Default",section:"Theme",handler:()=>{setThemeSetting("system")}}];</script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>